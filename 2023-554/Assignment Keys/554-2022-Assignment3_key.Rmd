---
title: "554-2022-Assignment3 key"
output:
  pdf_document: default
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

# Question 1 
 
```{r setup,message=FALSE,warning = FALSE}
### load libraries 
library(RColorBrewer)
library(rgdal)
library(INLA)
library(SUMMER)
library(spdep)
library(dplyr)
library(survey)
library(ggplot2)

# load data
data(BRFSS)
data(KingCounty)

# create neighborhood matrix for later
nb.r <- poly2nb(KingCounty, queen = F, row.names = KingCounty$HRA2010v2_) 
mat <- nb2mat(nb.r, style = "B", zero.policy = TRUE)
colnames(mat) <- rownames(mat)
mat <- as.matrix(mat[1:dim(mat)[1], 1:dim(mat)[1]])

# remove records with missing hracode and smoker1
BRFSS <- subset(BRFSS, !is.na(BRFSS$smoker1))
BRFSS <- subset(BRFSS, !is.na(BRFSS$hracode))

# compute naive estimates and standard errors
naive_data <- BRFSS %>%
  group_by(hracode) %>%
  summarise(est = mean(smoker1),
            n = length(smoker1)) %>%
  mutate(se = sqrt( est * (1 - est)/n)) %>%
  as.data.frame() 
# mapPlot() doesn't handle tibbles well, so if you're using tidyverse functionality, 
# convert your tibbles back to dataframes before plotting

# map of estimates
mapPlot(data = naive_data, geo = KingCounty, variables = "est",
    by.data = "hracode", by.geo = "HRA2010v2_", legend.label = "Naive Est.",
    is.long = FALSE) +
   ggtitle("Naive Estimates") +
   theme(strip.background = element_blank(), 
         plot.title = element_text(hjust = 0.5),
         panel.border = element_blank(),
         strip.text.x = element_blank())
# everything inside of theme() are all just extra ggplot options that 
# aren't strictly necessary but can be used to make plots look a bit different  
 
# map of standard errors
mapPlot(data = naive_data, geo = KingCounty, variables = "se",
    by.data = "hracode", by.geo = "HRA2010v2_", legend.label = "SE",
    is.long = FALSE) +
   ggtitle("Standard Errors (naive estimates)") +
   theme(strip.background = element_blank(), 
         plot.title = element_text(hjust = 0.5),
         panel.border = element_blank(),
         strip.text.x = element_blank())

```

# Question 2

```{r}
# create design object, get direct estimates
design <- svydesign(ids = ~1, weights = ~rwt_llcp, strata = ~strata, data = BRFSS)
direct <- svyby(~smoker1, ~hracode, design, svymean)
head(direct, n = 7)

# map of weighted estimates
mapPlot(data = direct, geo = KingCounty, variables = "smoker1",
    by.data = "hracode", by.geo = "HRA2010v2_", legend.label = "Weighted Est.",
    is.long = FALSE) +
   ggtitle("Weighted Estimates") +
   theme(strip.background = element_blank(), 
         plot.title = element_text(hjust = 0.5),
         panel.border = element_blank(),
         strip.text.x = element_blank())

# map of standard errors
mapPlot(data = direct, geo = KingCounty, variables = "se",
    by.data = "hracode", by.geo = "HRA2010v2_", legend.label = "SE",
    is.long = FALSE) +
   ggtitle("Standard Errors (weighted estimates)") +
   theme(strip.background = element_blank(), 
         plot.title = element_text(hjust = 0.5),
         panel.border = element_blank(),
         strip.text.x = element_blank())
```

# Question 3 

```{r}
# plot point estimates against each other
data.frame(direct = direct$smoker1, naive = naive_data$est) %>%
  ggplot(aes(naive, direct)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, col = "red") +
  coord_fixed() +
  xlab("Naive estimate") +
  ylab("Weighted estimate") 
```

The weighted estimates are in general higher for most regions than the naive estimates, as evidenced by the majority of the points in the graph above falling above the line with slope = 1, intercept = 0. 

```{r}
# plot standard errors against each other
data.frame(direct = direct$se, naive = naive_data$se) %>%
  ggplot(aes(naive, direct)) +
  geom_point() +
  xlab("Naive estimate SE") +
  ylab("Weighted estimate SE") +
  xlim (0, 0.07) + 
  ylim (0, 0.07) + 
  geom_abline(slope = 1, intercept = 0, col = "red") 

```

The standard errors of the weighted estimates are larger than the standard errors of the naive estimates, possibly because of the higher weighted estimates $\hat{p}_i's$. The standard errors of the naive estimates range from around 0.009 to 0.040, whereas the standard errors of the weighted estimates range from 0.014 to 0.08.

We have stratified, disproportionate sampling in the BRFSS data, and as such estimates that account for the survey design are most appropriate. This means the weighted estimates (and their standard errors) are the more appropriate summaries of the data.

# Question 4 

```{r}
# smoothed naive estimation
smoothed <- smoothSurvey(data = BRFSS, geo = KingCounty, Amat = mat,
    responseType = "binary", responseVar = "smoker1", strataVar = NULL,
    weightVar = NULL, regionVar = "hracode", clusterVar = NULL,
    CI = 0.95)

# extract posterior medians and map them
toplot <- smoothed$smooth
mapPlot(data = toplot, geo = KingCounty, variables = c("median"),
labels = c("Posterior Median"), by.data = "region", by.geo = "HRA2010v2_")

# extract posterior standard deviations and map them
toplot$sd <- sqrt(toplot$var)
mapPlot(data = toplot, geo = KingCounty, variables = c("sd"),
labels = c("Posterior SD"), by.data = "region", by.geo = "HRA2010v2_")
```

# Question 5 

```{r}
# plot point estimates against each other
data.frame(smoothed = toplot$median, naive = naive_data$est) %>%
  ggplot(aes(naive, smoothed)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, col = "red") +
  coord_fixed() +
  xlab("Naive estimate") +
  ylab("Smoothed binomial estimate")
```

The smoothed binomial estimates are roughly the same as the naive estimates for each region, though we can see that the range of the smoothed binomial estimates is slightly smaller than that of the naive estimates, implying some degree of smoothing has taken place.

```{r}
# plot standard error and posterior sd against each other
data.frame(smoothed = toplot$sd, naive = naive_data$se) %>%
  ggplot(aes(naive, smoothed)) +
  geom_point() +
  xlab("Naive estimate (SE)") +
  ylab("Smoothed binomial estimate (Posterior SD)") +
  xlim (0, 0.05) + 
  ylim (0, 0.05) + 
  geom_abline(slope = 1, intercept = 0, col = "red") 
```

The standard errors of the posterior standard deviations of the smoothed binomial estimates are slightly smaller than the one of the naive estimates. The standard errors of the naive estimates range from around 0.009 to 0.040, whereas the posterior standard deviations of the smoothed binomial estimates range from 0.008 to 0.027. This is again indicative of some degree of smoothing.

# Question 6 

```{r}
# smoothed weighted estimation
FHmodel <- smoothSurvey(data = BRFSS, geo = KingCounty, Amat = mat,
    responseType = "binary", responseVar = "smoker1", strataVar = "strata",
    weightVar = "rwt_llcp", regionVar = "hracode", clusterVar = "~1",
    CI = 0.95)

svysmoothed <- smoothSurvey(data = BRFSS, geo = KingCounty, Amat = mat,
                            responseType = "binary", responseVar = "smoker1",
                            strataVar = "strata",weightVar = "rwt_llcp",
                            regionVar = "hracode", clusterVar = "~1",
                            CI = 0.95)

 

toplot$fixedpm <- svysmoothed$fit$summary.fixed$`0.5quant`
mapPlot(data = toplot, geo = KingCounty, variables = c("fixedpm"),
        labels = c("Smoothed Naive Estimates"), by.data = "region",
        by.geo = "HRA2010v2_")

# extract posterior medians and map them
toplotFH <- FHmodel$smooth
mapPlot(data = toplotFH, geo = KingCounty, variables = c("median"),
labels = c("Posterior Median"), by.data = "region", by.geo = "HRA2010v2_")

# extract posterior standard deviations and map them
toplotFH$sd <- sqrt(toplotFH$var)
mapPlot(data = toplotFH, geo = KingCounty, variables = c("sd"),
labels = c("Posterior SD"), by.data = "region", by.geo = "HRA2010v2_")
```


# Question 7 

```{r}
# plot point estimates against each other
data.frame(smoothed = toplotFH$median, weighted = direct$smoker1) %>%
  ggplot(aes(weighted, smoothed)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, col = "red") +
  xlab("Weighted estimate") +
  ylab("Smoothed weighted estimate")
```

The smoothed weighted estimates are smoothed towards the center as expected. Areas with high weighted estimates are shrunk to lower values and areas with low weighted estimates are pulled toward higher values. Smoothed weighted estimates also exhibit lower variablility (a smaller range) compared to weighted estimates.

```{r}
# plot standard error and posterior sd against each other
data.frame(smoothed = toplotFH$sd, weighted = direct$se) %>%
  ggplot(aes(weighted, smoothed)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, col = "red") +
  xlab("Weighted estimate") +
  ylab("Smoothed weighted estimate")
```

The posterior standard deviations from the smoothed weighted model are in general smaller than the posterior standard deviations of the weighted model due to smoothing.


Which of the weighted or the smoothed weighted would you recommend using? Why?

There are two possible justifiable answers:

* I recommend using the smoothed weighted estimates, as the lower variances of the smoothed estimates is desirable (and may be needed) in order to make meaningful scientific conclusions about the proportion of smokers in each area. 

* I recommend using the weighted estimates, since they are design consistent, do not require assuming the form of a model, and sample sizes are large enough within each area to provide confidence intervals that are small enough to make meaningful scientific conclusions about the proportion of smokers in each area. 

# Question 8 

In general, smoking prevalence is highest in more Western parts of King County than Eastern parts of King County, with the highest prevalences being in the SeaTac/Tukwila, North Highline, and Delridge HRAs (according to the smoothed weighted model). We can see that HRAs with the lowest smoking prevalence tend to be gathered on the East side of Lake Washington, including Mercer Island and parts of Bellevue. Estimates in the table are reported as percentages.

```{r}
# Summarize the HRA variation in smoking prevalence across King County.

# HRAs with the highest prevalence according to each model? arrange table 
# according to smoothed weighted estimates

# A table is not necessary for points for this problem, but may be nice to 
# help compare HRAs across models
data.frame(region = toplot$region,
           naive = (naive_data$est * 100) %>% round(1),
           weighted = (direct$smoker1 * 100) %>% round(1),
           smoothed = (toplot$median * 100) %>% round(1),
           smoothed_weighted = (toplotFH$median * 100) %>% round(1)) %>%
  dplyr::arrange(smoothed_weighted) %>%
  knitr::kable("simple")
```
